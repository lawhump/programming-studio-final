function initMap(){app.Map=new app.views.Map}var app=function(){var e={localStorePrefix:"whisperingJourney-",views:{},models:{},collections:{},LoginView:null,init:function(){if(this.Me=new app.views.Me({el:$(".local-user")}),0!=localStorage.length){var e=localStorage.key(0),t=localStorage.getItem(e);if("true"==t){this.showCurrentLocation();var a=e.substring(18);this.Me.createWithUser(a)}}else this.LoginView=new app.views.Login;return this},showCurrentLocation:function(){console.log("here"),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude};this.pos=t,app.Map.map.setCenter(t),app.Map.map.setZoom(17)},function(){handleLocationError(!0,app.Map.map.getCenter())}):handleLocationError(!1,app.Map.map.getCenter())},handleLocationError:function(e,t){console.log(browserHasGeolocation?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")},syncClientAndServer:function(){if(void 0!=app.Me.username){var e=JSON.stringify({user:app.Me.username,location:app.pos});app.ws.send(e)}}};return console.log("initializing app"),e}();$(document).ready(function(){app.init();var e=location.origin.replace(/^http/,"ws"),t=new WebSocket(e);app.ws=t,t.onmessage=function(e){app.Feed.update(e)}}),$("#myModal").on("hidden.bs.modal",function(e){0==$("#me").length&&app.Me.createDefault()}),$(window).on("resize",function(){var e=$(window).height(),t=0;$("#map").css("height",e-t)}).resize();var app=app||{};!function(){"use strict";app.models.User=Backbone.Model.extend({location:null,username:"Guapo15",init:function(){}}),app.User=new app.models.User}();var app=app||{};!function(){"use strict";var e=Backbone.Collection.extend({model:app.models.User,nextOrder:function(){return this.length?this.last().get("order")+1:1},updateWithNewComment:function(){console.log("fuck"),app.CommitInfoView.render()},comparator:"order"});app.Users=new e,console.log("initializing users collection")}();var app=app||{};!function(){"use strict";app.views.Login=Backbone.View.extend({events:{"click #submit":"addUser","click #remember-user":"checkboxClicked","keypress #username":"keypressHandler"},el:"#myModal",initialize:function(){this.song=null,this.locCheckbox=document.getElementById("remember-location"),this.usrCheckbox=document.getElementById("remember-user"),this.render()},render:function(){$("#myModal").modal("show")},addUser:function(){var e=document.getElementById("username"),t=e.value;$("#myModal").modal("hide");var a;app.Map.locationToLatLng(app.Map.place.formatted_address).then(function(e){a=e;var o=JSON.stringify({user:t,location:a});void 0==app.Me.username&&(app.Me.username=t,app.Me.createWithUser(t)),app.ws.send(o)},function(e){console.log("cussed uppppp")}),this.usrCheckbox.checked&&(localStorage.clear(),this.locCheckbox.checked?localStorage[app.localStorePrefix+t.toLowerCase()]=!0:localStorage[app.localStorePrefix+t.toLowerCase()]=!1)},checkboxClicked:function(){document.getElementById("remember-user").checked?($("#remember-location").removeClass("hidden"),$("#remember-location").parent().removeClass("hidden")):($("#remember-location").addClass("hidden"),$("#remember-location").parent().addClass("hidden"))},keypressHandler:function(e){var t=e.keyCode?e.keyCode:e.which;13==t&&this.addUser()}})}();var app=app||{};!function(){"use strict";app.views.Feed=Backbone.View.extend({events:{},initialize:function(){this.res=null,this.render()},render:function(){return this},update:function(e){if(console.log(e),e.data.length>0){var t=JSON.parse(e.data),a=JSON.parse(t.song),o=$("#feed-template").html(),n=Handlebars.compile(o),i={user:t.user,song:a.recenttracks.track[0].name,artist:a.recenttracks.track[0].artist["#text"],cover:a.recenttracks.track[0].image[1]["#text"]||"http://placehold.it/64?text=No+image"},r=n(i),s=$("#"+t.user);void 0!=app.Me.username&&(0!=s.length?s.replaceWith(r):t.user.toLowerCase()==app.Me.username.toLowerCase()?app.Me.updateMe(a):app.Feed.$el.append(r),app.Map.updateMap(t))}}}),app.Feed=new app.views.Feed({el:$(".feed")})}();var app=app||{};!function(){"use strict";app.views.Map=Backbone.View.extend({el:"#map",events:{},initialize:function(){this.moved=!1,this.infowindow=null,this.infowindows=[],this.place=null,this.marker=null,this.markers=[],this.map=null,this.initMap()},initMap:function(){this.map=new google.maps.Map(document.getElementById("map"),{center:{lat:40.1058647,lng:-88.2193354},streetViewControl:!1,disableDefaultUI:!0,zoom:13});var e=document.getElementById("pac-input"),t=(document.getElementById("type-selector"),new google.maps.places.Autocomplete(e));t.bindTo("bounds",this.map),this.infowindow=new google.maps.InfoWindow,this.marker=new google.maps.Marker({map:this.map,anchorPoint:new google.maps.Point(0,-29)}),t.addListener("place_changed",function(){return app.Map.infowindow.close(),app.Map.marker.setVisible(!1),app.Map.place=t.getPlace(),app.Map.place.geometry?void(app.Map.moved||(app.Map.place.geometry.viewport?app.Map.map.fitBounds(app.Map.place.geometry.viewport):(app.Map.map.setCenter(app.Map.place.geometry.location),app.Map.map.setZoom(17)),app.Map.moved=!0)):void window.alert("Autocomplete's returned place contains no geometry")})},updateMap:function(e){console.log(this.infowindows);for(var t=-1,a=this.infowindows.length-1;a>=0;a--)this.infowindows[a].content.includes(e.user)&&(t=a);0>t?this.addUser(e):this.updateUser(e,t)},locationToLatLng:function(e){console.log(e);var t=$.Deferred(),a=new google.maps.Geocoder;return a.geocode({address:e},function(e,a){if(a==google.maps.GeocoderStatus.OK){var o={lat:e[0].geometry.location.lat(),lng:e[0].geometry.location.lng()};t.resolve(o)}else alert("Geocode was not successful for the following reason: "+a),t.reject(a)}),t.promise()},addUser:function(e){console.log(this.infowindows);var t,a=JSON.parse(e.song),o=(a.recenttracks.track[0].image[1]["#text"],a.recenttracks.track[0].name);t=null!=this.place?new google.maps.Marker({position:this.place.geometry.location,map:this.map}):new google.maps.Marker({position:e.location,map:this.map}),t.setIcon({size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(50,50)}),this.markers.push(t);var n=new google.maps.InfoWindow({maxWidth:300});t.setPosition(new google.maps.LatLng(e.location)),t.setVisible(!0),n.setContent("<div><strong>"+e.user+"</strong><br>"+o),t.addListener("click",function(){n.open(this.map,t)}),this.infowindows.push(n)},updateUser:function(e,t){var a=JSON.parse(e.song),o=(a.recenttracks.track[0].image[1]["#text"],a.recenttracks.track[0].name),n=this.markers[t];n.setIcon({size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(50,50)});var i=this.infowindows[t];n.setPosition(new google.maps.LatLng(e.location)),n.setVisible(!0),i.setContent("<div><strong>"+e.user+"</strong><br>"+o)}}),app.Map=new app.views.Map}();var app=app||{};!function(){"use strict";app.views.Me=Backbone.View.extend({events:{"click #cta":"ctaHandler","click #relocate":"relocateHandler"},initialize:function(){this.source=$("#me-template").html(),this.template=Handlebars.compile(this.source),this.render()},render:function(){return this},createWithUser:function(e){this.$el.empty(),console.log("Creating me with user "+e),this.username=e,$(".local-user").removeClass("hidden");var t="https://ws.audioscrobbler.com/2.0/?",a="api_key=3d386c221b36c1442b384aa1d853bc8c",o="format=json",n="method=user.getRecentTracks",i="limit=1",r=t;r+=a+"&",r+=o+"&",r+=n+"&",r+=i+"&",r+="user="+e,$.ajax({url:r,data:{key:"value"},error:function(){console.log("something went wrong")},dataType:"json",success:function(e){var t={header:app.Me.username,subheader:e.recenttracks.track[0].name+" - "+e.recenttracks.track[0].artist["#text"],image:e.recenttracks.track[0].image[1]["#text"]||"http://www.bobjames.com/wp-content/themes/soundcheck/images/default-album-artwork.png",cta:"Sign out"},a=app.Me.template(t);app.Me.$el.append(a),$("#relocate").removeClass("hidden")},type:"GET"})},createDefault:function(){this.$el.empty(),console.log("Creating me with default user/sign in prompt"),$(".local-user").removeClass("hidden");var e={header:"Sign in and fit in",subheader:'It is as simple as pressing the "SIGN IN" button.',image:"http://placehold.it/100x100&text=No+image+available",cta:"Sign in"},t=this.template(e);app.Me.$el.append(t)},updateMe:function(e){console.log(e);var t={header:app.Me.username,subheader:e.recenttracks.track[0].name+" - "+e.recenttracks.track[0].artist["#text"],image:e.recenttracks.track[0].image[2]["#text"]||"http://www.bobjames.com/wp-content/themes/soundcheck/images/default-album-artwork.png",cta:"Sign out"},a=app.Me.template(t);this.$el.empty(),this.$el.append(a),$("#relocate").removeClass("hidden")},ctaHandler:function(){$("#relocate").hasClass("hidden")?app.LoginView.render():localStorage.clear()},relocateHandler:function(){app.LoginView.render()}})}();